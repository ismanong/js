/*开发豆原创源码，唯一官网：www.kaifadou.com*/
$(function() {
  comment()//新评论
})

/*评论*/
function commentSeo(){
  var plHeight = $("#comment_0 dl").height();
  var dtHeight = 0;
  for(i=0;i<5;i++){
    dtHeight += $("#comment_0 dl dt").eq(i).height() + 10;
    dtHeight += $("#comment_0 dl dd").eq(i).height() + 6;
  };
  //alert(dtHeight)
  if(plHeight>=dtHeight){
    $("#comment_0 dl").css("height",dtHeight);
    $(".m-look-ly").show();
  }else{
    $(".m-look-ly").hide();
  }
  $(".m-look-ly").click(function(){
    var btnText = $(".m-look-ly").text()
    if(btnText == '查看更多评论'){
      $("#comment_0 dl").animate({"height":plHeight},200);
      $(this).text("收起评论")
    }else if(btnText == '收起评论'){
      $("#comment_0 dl").animate({"height":dtHeight},200);
      $(this).text("查看更多评论")
    }

  });
}
function addRealCommont(data){
  var comment = '<dt><span><i>最高楼</i><b>您的评论 网友 客人</b> </span><em>发表于: <font color="red"> '+showTime()+' </font>  </em></dt>'
  comment += '<dd>{0}<p id="'+$("#app-id").val()+'"><a href="javascript:">支持<em>(</em><span> 0 </span><em>)</em></a> <a href="javascript:" pid="'+$("#app-id").val()+'">盖楼(回复)</a> </p></dd>';
  comment = comment.replace("{0}",data);
  $("#comment_0 dl").prepend(comment);
}
function commontSubmit(){
  if(CommentTpye==1){
    var id = $("#app-id").val();
    var content = $(".w-text textarea").val();
    if($.trim(content).length <= 2) {
    alert("请填写内容");
    return;
    }
    $.ajax({
     type: 'POST',
     url: '/ajax.asp',
     data:  {
         content :content,
          SoftID :id,
         Action : 2,
         CommentTpye : 1  // 此处为服务端接口拼写错误
        },
     success: function(s){
         alert("提交成功");
         $(".w-text textarea").text("");
         addRealCommont(s)
       },
     dataType: ""
    });
  }
  if(CommentTpye==0){
    var id = $("#app-id").val();
    var content = $(".w-text textarea").val();
    if($.trim(content).length <= 2) {
    alert("请填写内容");
    return;
    }
    $.ajax({
     type: 'POST',
     url: '/ajax.asp',
     data:  {
         content :content,
          SoftID :id,
         Action : 2,
         CommentTpye : 0  // 此处为服务端接口拼写错误
        },
     success: function(s){
         alert("提交成功");
         $(".w-text textarea").text("");
         addRealCommont(s)
       },
     dataType: ""
    });
  }
}
function showTime(){
var mydate = new Date();
var str = "" + mydate.getFullYear() + "年";
str += (mydate.getMonth()+1) + "月";
str += mydate.getDate() + "日";
return str;
}
function downShowcontent(){
   window.onload=function(){
    // 要获取图片高度，需要等加载完再执行
    var contentHeight = $(".g-down-content").height();
    $(".g-down-content").height(180);
    $(".m-show-content p").click(function(){
      var btnText = $(this).text().replace(/\s+/g,"")
      if(btnText=="加载全部内容>>>" || btnText=="点击查看更多"){
        $(".g-down-content").animate({height:contentHeight},300);
        $(this).text("点击收起内容").append("<b></b>")
      }else{
        $(".g-down-content").animate({height:180},300);
        $(this).text("加载全部内容>>>").append("<b></b>");
        var offsetTop = $(".g-down-introd").offset().top;
        $("body,html").animate({scrollTop:offsetTop},300)
      }
    })
  }

}


// 新留言

function comment(){//评论
  if($("#comment_0 dl dt").length<5){
    $(".g-comment-more").hide();  
  };

  var p=1;
  function ViewMore(){             
    p++;
    $.ajax({
      type: "Get",
      url: "/sajax.asp",
      data: "action=6&t="+_pageinfo.id+"&s="+CommentTpye+"&num=5&p="+p,
      success: function(msg){       
        var objJson =eval( '(' + msg + ')');
        if (objJson.PageCount >= p){
          listDate(msg);
        }else{
          $(".g-comment-more").text("没有更多评论了").css("background","#c3c3c3");
        }
      }
    });       
  }
  function listDate(msg){
    var objJson =eval( '(' + msg + ')');
    var html = '';
    var htmlnew = '';   
    for(var i=0; i<objJson.softid.length;i++ )
    {     
      html += '<dt>';
      html += '<span><i>第'+objJson.Graded[i]+'楼</i><b>'+objJson.sUserFrom[i]+' '+objJson.user[i]+'</b> </span><em>发表于: '+objJson.DateAndTime[i]+'  </em>';
      html += '</dt>';
      html += '<dd>';
      html += objJson.Excerpt[i];
      html += '</dd>';  
      
      htmlnew += '<dt class="clearfix"><i>第 '+objJson.Graded[i]+' 楼 </i><span><b>腾牛网友</b> <em>'+objJson.DateAndTime[i]+'</em></span></dt>';
      if(objJson.bjhf[i]==""){
        htmlnew += '<dd>'+objJson.Excerpt[i]+'<p id="'+objJson.Id[i]+'"><a href="javascript:">支持<em>(</em><span> 0 </span><em>)</em></a> <a href="javascript:" pid="'+objJson.Id[i]+'">盖楼(回复)</a> </p></dd>'; 
      }else{
        htmlnew += '<dd>'+objJson.Excerpt[i]+'<div class="m-huifu"><p class="m-huifu-o">编辑回复：<br><span>'+objJson.bjhf[i]+'</span></p></div><p id="'+objJson.Id[i]+'"><a href="javascript:">支持<em>(</em><span> 0 </span><em>)</em></a> <a href="javascript:" pid="'+objJson.Id[i]+'">盖楼(回复)</a> </p></dd>'; 
      }
       
     }; 
    $('.g-game-ly div dl').append(html);
    $('.g-game2-ly div dl').append(htmlnew);
    BindDing("#comment_0 > dl > dd > p",_pageinfo.id,"0")

  };
  $(".g-comment-more").click(function(){
    ViewMore(); 
  });
  var commentCont = '<div id="m-comment-box" style="display:none"><fieldset class="w-text"><textarea></textarea></fieldset><fieldset class="w-button"><input id="verify" class="button disable" type="button"  value="提交评论" /><b class="m-comment-close">取消</b></fieldset><input type="hidden" id="app-id" value="'+_pageinfo.id+'"/></div>';
  $(".g-commentbox").prepend(commentCont);
  $("#comment_0 dl dt").each(function(){
    $(this).find("b").text("腾牛网友")
  })
  plhuifu() //回复，支持进行操作
  function plhuifu(){


    $(".g-comment-showbtn").click(function(){ 
      $("#m-comment-box").show(); 
      $(this).hide();
      $("#comment_list").hide();
      
      
      plcole()
    }); 

    $("#comment_list div dl dd").each(function(){
      $(this).find("p a:eq(1)").click(function(){
        var pid = $(this).attr("pid");
        $("#m-comment-box").show();
        $(".g-comment-showbtn").hide();
        $("#m-comment-box textarea").text("[quote]"+pid+"[/quote]").focus();

        
        plcole()
      })
      

    });
  }

  $("#verify").click(function(){
        commontSubmit();
  });
  function plcole(){
    $(".m-comment-close").click(function(){
      $("#m-comment-box").hide(); 
      $("#comment_list,.g-comment-showbtn").show();
      
    });
  }

};
function commontSubmit(){

  function showTime(){
  var mydate = new Date();
  var str = "" + mydate.getFullYear() + "年";
  str += (mydate.getMonth()+1) + "月";
  str += mydate.getDate() + "日";
  return str;
  }
  var id = $("#app-id").val();
    var content = $(".w-text textarea").val();
    if($.trim(content).length <= 2) {
    alert("请填写内容");  
    return;
  }
  if(CommentTpye==1){
    $.ajax({
     type: 'POST',
     url: '/ajax.asp',
     data:  {
         content :content,
          SoftID :id,
         Action : 2,
         CommentTpye : 1  // 此处为服务端接口拼写错误
        },
     success: function(s){
         alert("提交成功");
         $(".w-text textarea").text("");           
         //addRealCommont(s);        
       },
     dataType: ""
    });
  }
  if(CommentTpye==0){//下载
    //不经过ajax，直接获取内容
    
    

    $.ajax({
     type: 'POST',
     url: '/ajax.asp',
     data:  {
         content :content,
          SoftID :id,
         Action : 2,
         CommentTpye : 0  // 此处为服务端接口拼写错误
        },
     success: function(s){
         alert("提交成功");
         $("#comment_list,.g-comment-showbtn").show();
        $("#m-comment-box").hide();       
          $(".w-text textarea").val("");
        // addRealCommont(s)
         //console.log("返回信息成功")
       },
     dataType: ""
    });
    
  }
  var comment = '<dt><span><i>最高楼</i><b>您的评论 网友 客人</b> </span><em>发表于: <font color="red"> '+showTime()+' </font>  </em></dt>'
  comment += '<dd>'+content+'<p id="'+$("#app-id").val()+'"><a href="javascript:">支持<em>(</em><span>0</span><em>)</em></a> <a href="javascript:" pid="'+$("#app-id").val()+'">盖楼(回复)</a> </p></dd>';
  
  var newcomment = '<dt class="clearfix"><i>最高楼</i><span><b>您的评论</b> <em><font color="red"> '+showTime()+' </font></em></span></dt>';
  newcomment += '<dd>'+content+'<p id="'+$("#app-id").val()+'"><a href="javascript:">支持<em>(</em><span>0</span><em>)</em></a> <a href="javascript:" pid="'+$("#app-id").val()+'">盖楼(回复)</a> </p></dd>'; 
  $('.g-game-ly div dl').prepend(comment);
  $('.g-game2-ly div dl').prepend(newcomment);
  

}
//评论页读取顶
var oid = $('#app-id').val();
function BindDing(objtext,id,CommentTpye){
  var obj = $('#comment_list dl dd p');
  if (obj.length === 0) {
      return false;
  }
  for (var i=0 ;i<obj.length;i++)
   {

    var sobj = obj.eq(i).find('a').first();
    var spanobj = obj.eq(i).find("span")
    sobj.click(function (){ 
       SendDing($(this).parent().attr("id"));
       var spanobj = $(this).parent().find("span")
       spanobj.html(parseInt(spanobj.html(),0)+1);
        $(this).unbind();             
        $(this).attr("title","您已经顶过了");
       })
   }
  ReadDing(objtext,id,CommentTpye)
}

function SendDing(id)//发送顶
{
  var id = $("#app-id").val();
   var url="action=19&id="+id
   //var url="action=19"
   $.ajax({
   type: "POST",
   url: "/ajax.asp",
   data: url,
   success: function(msg){
   // console.log("支持数据提交成功")
      //alert(msg)  ;
   }
});
}

//读取评论顶的数据
function ReadDing(objtext,id,CommentTpye)
{
  var obj=$('#comment_list dl dd p');
  
  //return ; //退出
  
  var sendid="";
  for (var i=0 ;i<obj.length;i++)
  {
    sendid+=obj.eq(i).attr("id");
    if (i<(obj.length-1)) sendid+=",";
  }
  
if (sendid!=""){ //是否有评论
 
    var url="action=18&id="+id+"&CommentTpye="+CommentTpye+"&sendid="+escape(sendid)+""
    $.ajax({
     type: "POST",
     url: "/ajax.asp",
     data: url,
     success: function(msg){
      ListDing(objtext,msg)  ;
     }
  }); 
 }
}

function ListDing(objtext,msg) //显示顶的数据
{
  //alert(msg)
  var obj=$(objtext)
  var dataObj=eval("("+msg+")");//转换为json对象
   for (var i=0 ;i<obj.length;i++)
   { 
     var spanobj = obj.eq(i).find("span")
     var sid = obj.eq(i).attr("id");
     for (var y=0;y < dataObj.ID.length;y++)
     {
       if (sid == dataObj.ID[y])
       {
       spanobj.html(dataObj.Ding[y]);
       break;
       }
     }
  } 
}
//新留言结束
